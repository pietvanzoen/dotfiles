#!/bin/bash

set -e

function main() {
  local branch

  branch=$(git symbolic-ref --short HEAD)

  assert_not_master

  update_master

  assert_feature_up_to_date

  merge_feature

  cleanup

}

function assert_not_master() {
  if [[ $branch == 'master' ]]; then
    error "Current branch is master. Exiting."
    exit 1
  fi
}

function update_master() {
  info "updating master"
  git checkout master --quiet
  git pull
}

function assert_feature_up_to_date() {
  local missing_commits
  missing_commits="$(git log master --pretty="* %h - %s [%an]" --not "$branch")"

  if [[ $missing_commits ]]; then
    error "Branch $branch is missing the following commits from master. Rebase and try again."
    echo "$missing_commits"
    git checkout "$branch" --quiet
    exit 1
  fi

}

function merge_feature() {
  info "merging $branch"
  git merge --ff-only "$branch"
  git push
}

function cleanup() {
  info "cleaning up"
  git branch -d "$branch"
  git push origin --delete "$branch"
}

function info() {
  echo
  echo "$(tput setaf 6)>> $1$(tput sgr0)"
}

function error() {
  echo
  echo "$(tput setaf 1)>> $1$(tput sgr0)"
}

main
