#!/bin/bash

set -e


if [[ -z "$1" ]]; then
  TEMPFILE="$(mktemp --suffix .txt)"
  trap cleanup EXIT
  echo "$(</dev/stdin)" > $TEMPFILE
  FILEPATH="$TEMPFILE"
  FILENAME="$(basename $FILEPATH | sed 's/tmp\.//')"
else
  FILEPATH="$1"
  FILENAME="$(basename $FILEPATH)"
fi

cleanup() {
  rm -f $TEMPFILE
}

BUCKET=img.piet.me
AWS_PROFILE=piet-s3
S3_FILE_PERMS=public-read

bucket_location=$BUCKET/$FILENAME

aws s3 cp \
  --profile=$AWS_PROFILE \
  --acl=$S3_FILE_PERMS \
  --quiet \
  $FILEPATH \
  s3://$bucket_location

location="http://$bucket_location"
echo $location | pbcopy
echo $location
