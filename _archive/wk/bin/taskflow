#!/usr/bin/env bash
set -e

[[ -n "$TMUX" ]] && tmux rename-window -t${TMUX_PANE} "taskflow"

cleanup() {
  [[ -n "$TMUX" ]] && tmux set-window-option automatic-rename "on"
}

trap cleanup EXIT
if [[ -z "$TASKFLOW_DIR" ]]; then
  (>&2 echo "Error: TASKFLOW_DIR not set")
  exit 1
fi
cd "$TASKFLOW_DIR"

CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"

CMD=$1
shift

exe() { echo "==> $@" ; ($@) ; }

case $CMD in
  pull)
    if [[ $CURRENT_BRANCH != "master" ]]; then
      exe "git wip"
      exe "git fetch-rebase master"
    else
      exe "git tidy"
    fi
    ;;


  update)
    exe "yarn install"
    exe "yarn build:dev"
    ;;


  start)
    if [[ -z "$(docker ps | grep wk_app_taskflow_gateway)" ]]; then
      exe "yarn gateway"
    fi
    exe "yarn start:dev"
    ;;

  validate)
    exe "yarn build:all"
    exe "npx lerna run test:ci --stream"
  ;;

  e2e)
    (
      cd tf-aura-ui
      exe "yarn cypress:run:local"
    )
    (
      cd tf-aura-edge
      exe "yarn test:ci"
    )
  ;;

  *)
    if [[ -z "$CMD" ]]; then
      echo "USAGE: taskflow (update|start)"
      exit 0
    fi
    ;;
esac

cleanup
