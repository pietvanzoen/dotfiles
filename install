#!/bin/bash

set -e

if [[ ! "$(basename $(pwd))" == "dotfiles" ]]; then
  echo "Run install from dotfiles directory"
  exit 1
fi

INSTALLED_INDEX_TMP="$(mktemp)"
INSTALLED_INDEX="./.installed_packages"

stowable="$(ls -d */ | grep -v _ | grep -v stow | tr -d /)"

echo
echo "==> Initializing .stowrc"
cp -vi ./stow/.stowrc.example ./stow/.stowrc
sed -i "s|\$HOME|$HOME|" ./stow/.stowrc
cat ./stow/.stowrc
echo "stow" >> "$INSTALLED_INDEX_TMP"

echo
echo "==> Installing stow"
stow --verbose --target $HOME --ignore=.*.example stow

for package in $stowable; do
  echo
  read -r -p "==> Install $package? [y/n]" install
  if [ "$install" == 'y' ]; then
    echo "==> Installing $package"
    echo "$package" >> "$INSTALLED_INDEX_TMP"
    (
    cd $package
    examples="$((ls -a | grep example) || echo)"
    for example in $examples; do
      cp -vn "$example" "$(echo $example | sed 's/.example//')"
    done
    )
    stow $package
  fi
done

mv -f "$INSTALLED_INDEX_TMP" "$INSTALLED_INDEX"

echo
echo "==> Installed these packages:"
cat "$INSTALLED_INDEX"
